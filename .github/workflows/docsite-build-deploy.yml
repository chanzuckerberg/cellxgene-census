name: Build and Deploy Docsite
on:
  push:
    branches:
      - docsite
permissions:
  contents: write
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Install Python deps üîß 
        run: |
          pip install -r docs/requirements.txt
          pip install ./api/python/cellxgene_census
          mkdir -p docsite
          touch docsite/.nojekyll

      # - uses: r-lib/actions/setup-r@v2
      #   with:
      #     extra-repositories: https://tiledb-inc.r-universe.dev

      # - uses: r-lib/actions/setup-r-dependencies@v2
      #   with:
      #     working-directory: ./api/r/cellxgene.census
      #     extra-packages: any::rcmdcheck, any::styler, any::roxygen2, any::pkgdown
      #     needs: check
      #     cache: true

      - name: Build Sphinx website
        run: |
          cd docs/
          make clean && make html
          cp -r _build/html/* ../docsite/.

      # - name: Build pkgdown website
      #   run: |
      #     cd api/r/cellxgene.census
      #     Rscript -e 'pkgdown::build_site()'
      #     cd /
      #     mkdir -p docsite/r
      #     cp api/r/cellxgene.census/docs docsite/r/.

      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docsite # The folder the action should deploy.
          branch: gh-pages-test